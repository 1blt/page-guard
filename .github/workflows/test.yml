name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-all-protections:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.guard.outputs.images-processed }}
      obfuscated: ${{ steps.guard.outputs.files-obfuscated }}
      metadata: ${{ steps.guard.outputs.metadata-stripped }}
      decoys: ${{ steps.guard.outputs.decoys-injected }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Page Guard
        id: guard
        uses: ./
        with:
          path: './test/site'
          generate-summary: 'false'

      - name: Verify minification worked
        run: |
          if grep -q '<!--.*-->' test/site/index.html; then
            echo "Error: HTML comments were not removed"
            exit 1
          fi

      - name: Verify poison data injected
        run: |
          if ! grep -q 'aria-hidden="true"' test/site/index.html; then
            echo "Error: Poison data was not injected"
            exit 1
          fi

      - name: Verify metadata stripped
        run: |
          if grep -q 'name="generator"' test/site/index.html; then
            echo "Error: Metadata was not stripped"
            exit 1
          fi

  test-full-image-protection:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.guard.outputs.images-processed }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Page Guard (with neural network protection)
        id: guard
        uses: ./
        with:
          path: './test/site'
          full-image-protection: 'true'
          generate-summary: 'false'

      - name: Verify full protection
        run: |
          if [ "${{ steps.guard.outputs.images-processed }}" -lt 1 ]; then
            echo "Error: No images were processed with full protection"
            exit 1
          fi

  test-output-path:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.guard.outputs.images-processed }}
      obfuscated: ${{ steps.guard.outputs.files-obfuscated }}
      metadata: ${{ steps.guard.outputs.metadata-stripped }}
      decoys: ${{ steps.guard.outputs.decoys-injected }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Page Guard (separate output directory)
        id: guard
        uses: ./
        with:
          path: './test/site'
          output-path: './protected'
          generate-summary: 'false'

      - name: Verify output directory
        run: |
          if [ ! -d "./protected" ]; then
            echo "Error: Output directory was not created"
            exit 1
          fi
          if [ ! -f "./protected/index.html" ]; then
            echo "Error: HTML not in output directory"
            exit 1
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [test-all-protections, test-full-image-protection, test-output-path]
    if: always()

    steps:
      - name: Generate Test Summary
        run: |
          echo "## Page Guard Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Protection summary table (in execution order)
          echo "| # | Protection | Status | Count | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|---|------------|--------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Metadata Stripping | ${{ needs.test-all-protections.result == 'success' && '**Enabled**' || 'Failed' }} | ${{ needs.test-all-protections.outputs.metadata }} files | Stripped EXIF data, generator tags, and sensitive metadata from images and HTML |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Image Protection | ${{ needs.test-all-protections.result == 'success' && '**Enabled**' || 'Failed' }} | ${{ needs.test-all-protections.outputs.images }} images | Applied adversarial perturbations (DCT watermarking, wavelet transforms, strategic noise) |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Obfuscation | ${{ needs.test-all-protections.result == 'success' && '**Enabled**' || 'Failed' }} | ${{ needs.test-all-protections.outputs.obfuscated }} files | Removed comments and minified HTML, CSS, and JavaScript files |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Anti-Scraping | ${{ needs.test-all-protections.result == 'success' && '**Enabled**' || 'Failed' }} | ${{ needs.test-all-protections.outputs.decoys }} decoys | Injected honeypot links and poison data to pollute AI training datasets |" >> $GITHUB_STEP_SUMMARY
          echo "| - | Full Neural Network | ${{ needs.test-full-image-protection.result == 'success' && '**Pass**' || 'Failed' }} | ${{ needs.test-full-image-protection.outputs.images }} images | Adversarial perturbations using ResNet50 model |" >> $GITHUB_STEP_SUMMARY
          echo "| - | Output Directory | ${{ needs.test-output-path.result == 'success' && '**Pass**' || 'Failed' }} | - | Writes protected files to separate output directory |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Details section
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Execution Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Order" >> $GITHUB_STEP_SUMMARY
          echo "1. **Metadata Stripping** - Runs first to clean EXIF/metadata from images before protection" >> $GITHUB_STEP_SUMMARY
          echo "2. **Image Protection** - Applies adversarial perturbations to already-clean images" >> $GITHUB_STEP_SUMMARY
          echo "3. **Obfuscation** - Minifies and removes comments from HTML/CSS/JS" >> $GITHUB_STEP_SUMMARY
          echo "4. **Anti-Scraping** - Injects decoys last so they remain in final output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configurations" >> $GITHUB_STEP_SUMMARY
          echo "- **All Protections**: In-place modification with all 4 protections enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Full Neural Network**: Enables PyTorch-based adversarial perturbations (ResNet50)" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Directory**: Tests writing to separate \`./protected\` directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
